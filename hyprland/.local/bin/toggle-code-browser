#!/bin/bash
# Proper fullscreen toggle - exits fullscreen before switching
# Save as ~/.local/bin/proper-fullscreen-toggle

current_class=$(hyprctl activewindow -j | jq -r '.class')
current_fullscreen=$(hyprctl activewindow -j | jq -r '.fullscreen')

case "$current_class" in
    "org.qutebrowser.qutebrowser")
        echo "Switching from qutebrowser to Alacritty..."
        # Exit fullscreen first if currently fullscreen
        if [[ "$current_fullscreen" == "true" ]]; then
            hyprctl dispatch fullscreen 0  # Exit fullscreen
            sleep 0.2
        fi

        # Switch to Alacritty and fullscreen it
        if hyprctl clients | grep -qi "Alacritty"; then
            hyprctl dispatch focuswindow "class:Alacritty"
            sleep 0.3
            hyprctl dispatch fullscreen 1
        else
            alacritty > /dev/null 2>&1 &
            sleep 1
            hyprctl dispatch focuswindow "class:Alacritty"
            sleep 0.3
            hyprctl dispatch fullscreen 1
        fi
        ;;
    "Alacritty")
        echo "Switching from Alacritty to qutebrowser..."
        # Exit fullscreen first if currently fullscreen
        if [[ "$current_fullscreen" == "true" ]]; then
            hyprctl dispatch fullscreen 0  # Exit fullscreen
            sleep 0.2
        fi

        # Switch to qutebrowser and fullscreen it
        if hyprctl clients | grep -qi "org.qutebrowser.qutebrowser"; then
            hyprctl dispatch focuswindow "class:org.qutebrowser.qutebrowser"
            sleep 0.3
            hyprctl dispatch fullscreen 1
        else
            ~/.local/share/qutebrowser-env/bin/qutebrowser > /dev/null 2>&1 &
            # Wait for qutebrowser to appear
            for i in {1..15}; do
                if hyprctl clients | grep -qi "org.qutebrowser.qutebrowser"; then
                    sleep 0.5
                    hyprctl dispatch focuswindow "class:org.qutebrowser.qutebrowser"
                    sleep 0.3
                    hyprctl dispatch fullscreen 1
                    break
                fi
                sleep 0.3
            done
        fi
        ;;
    *)
        echo "From other window, going to qutebrowser..."
        if hyprctl clients | grep -qi "org.qutebrowser.qutebrowser"; then
            hyprctl dispatch focuswindow "class:org.qutebrowser.qutebrowser"
            sleep 0.3
            hyprctl dispatch fullscreen 1
        else
            ~/.local/share/qutebrowser-env/bin/qutebrowser > /dev/null 2>&1 &
            for i in {1..15}; do
                if hyprctl clients | grep -qi "org.qutebrowser.qutebrowser"; then
                    sleep 0.5
                    hyprctl dispatch focuswindow "class:org.qutebrowser.qutebrowser"
                    sleep 0.3
                    hyprctl dispatch fullscreen 1
                    break
                fi
                sleep 0.3
            done
        fi
        ;;
esac
