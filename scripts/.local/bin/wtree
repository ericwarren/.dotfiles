#!/usr/bin/env bash
# wtree - Git worktree + tmux development environment creator
# Usage: wtree <branch-name> [base-branch]

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

error() {
    echo -e "${RED}Error: $1${NC}" >&2
    exit 1
}

info() {
    echo -e "${BLUE}$1${NC}"
}

success() {
    echo -e "${GREEN}$1${NC}"
}

warn() {
    echo -e "${YELLOW}$1${NC}"
}

# Check if we're in a git repository
if ! git rev-parse --git-dir > /dev/null 2>&1; then
    error "Not in a git repository"
fi

# Get branch name from argument
BRANCH_NAME="$1"
BASE_BRANCH="${2:-HEAD}"

if [ -z "$BRANCH_NAME" ]; then
    echo "Usage: wtree <branch-name> [base-branch]"
    echo ""
    echo "Creates a git worktree and opens it in a tmux session with Claude Code"
    echo ""
    echo "Arguments:"
    echo "  branch-name   Name of the new branch to create"
    echo "  base-branch   Branch to base the new branch on (default: HEAD)"
    echo ""
    echo "Example:"
    echo "  wtree feature-auth          # Create from current HEAD"
    echo "  wtree fix-bug main          # Create from main branch"
    exit 1
fi

# Get repository root and name
REPO_ROOT=$(git rev-parse --show-toplevel)
REPO_NAME=$(basename "$REPO_ROOT")

# Sanitize branch name for filesystem and tmux
SAFE_BRANCH=$(echo "$BRANCH_NAME" | sed 's/[^a-zA-Z0-9_-]/_/g')

# Worktree directory (sibling to repo)
WORKTREE_BASE="$REPO_ROOT/../worktrees"
WORKTREE_DIR="$WORKTREE_BASE/$SAFE_BRANCH"

# Tmux session name
SESSION_NAME="${REPO_NAME}-${SAFE_BRANCH}"

# Check if branch already exists
if git show-ref --verify --quiet "refs/heads/$BRANCH_NAME"; then
    error "Branch '$BRANCH_NAME' already exists. Use 'wtree-attach $BRANCH_NAME' to attach to existing worktree."
fi

# Check if worktree already exists
if [ -d "$WORKTREE_DIR" ]; then
    error "Worktree directory already exists: $WORKTREE_DIR"
fi

# Check if tmux session already exists
if tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
    warn "Tmux session '$SESSION_NAME' already exists. Attaching to it..."
    if [ -n "$TMUX" ]; then
        tmux switch-client -t "$SESSION_NAME"
    else
        tmux attach-session -t "$SESSION_NAME"
    fi
    exit 0
fi

# Create worktree base directory if it doesn't exist
mkdir -p "$WORKTREE_BASE"

info "Creating worktree for branch '$BRANCH_NAME' based on '$BASE_BRANCH'..."

# Create worktree with new branch
if ! git worktree add -b "$BRANCH_NAME" "$WORKTREE_DIR" "$BASE_BRANCH"; then
    error "Failed to create worktree"
fi

success "Worktree created at: $WORKTREE_DIR"

# Create tmux session
info "Creating tmux session: $SESSION_NAME"

# Create new session with left pane (terminal)
tmux new-session -d -s "$SESSION_NAME" -c "$WORKTREE_DIR"

# Split vertically for Claude Code (right pane)
tmux split-window -h -c "$WORKTREE_DIR" -t "$SESSION_NAME"

# Start Claude Code in right pane
tmux send-keys -t "$SESSION_NAME:0.1" "claude" C-m

# Select left pane (terminal)
tmux select-pane -t "$SESSION_NAME:0.0"

# Set pane titles
tmux set-option -t "$SESSION_NAME" pane-border-format " #[fg=colour250,bold]#{pane_current_command} #[fg=colour244](#P) #[fg=colour39][$BRANCH_NAME] "

success "Tmux session '$SESSION_NAME' created"

# Attach to session
info "Attaching to session..."
if [ -n "$TMUX" ]; then
    tmux switch-client -t "$SESSION_NAME"
else
    tmux attach-session -t "$SESSION_NAME"
fi
