#!/usr/bin/env bash
# wtree-rm - Remove a git worktree and kill its associated tmux session
# Usage: wtree-rm <branch-name>

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

error() {
    echo -e "${RED}Error: $1${NC}" >&2
    exit 1
}

info() {
    echo -e "${BLUE}$1${NC}"
}

success() {
    echo -e "${GREEN}$1${NC}"
}

warn() {
    echo -e "${YELLOW}$1${NC}"
}

# Check if we're in a git repository
if ! git rev-parse --git-dir > /dev/null 2>&1; then
    error "Not in a git repository"
fi

# Get branch name from argument
BRANCH_NAME="$1"

if [ -z "$BRANCH_NAME" ]; then
    echo "Usage: wtree-rm <branch-name>"
    echo ""
    echo "Removes a git worktree and kills its associated tmux session"
    echo ""
    echo "Available worktrees:"
    wtree-ls
    exit 1
fi

# Get repository info
REPO_ROOT=$(git rev-parse --show-toplevel)
REPO_NAME=$(basename "$REPO_ROOT")

# Sanitize branch name
SAFE_BRANCH=$(echo "$BRANCH_NAME" | sed 's/[^a-zA-Z0-9_-]/_/g')

# Worktree directory
WORKTREE_BASE="$REPO_ROOT/../worktrees"
WORKTREE_DIR="$WORKTREE_BASE/$SAFE_BRANCH"

# Tmux session name
SESSION_NAME="${REPO_NAME}-${SAFE_BRANCH}"

# Check if worktree exists
if ! git worktree list | grep -q "$WORKTREE_DIR"; then
    error "Worktree for branch '$BRANCH_NAME' not found"
fi

# Confirm deletion
warn "This will remove:"
echo "  - Worktree: $WORKTREE_DIR"
echo "  - Branch: $BRANCH_NAME"
if tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
    echo "  - Tmux session: $SESSION_NAME"
fi
echo ""
read -p "Are you sure? (y/N) " -n 1 -r
echo ""

if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    info "Aborted"
    exit 0
fi

# Kill tmux session if it exists
if tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
    info "Killing tmux session: $SESSION_NAME"
    tmux kill-session -t "$SESSION_NAME"
    success "Tmux session killed"
fi

# Remove worktree (this also deletes the branch)
info "Removing worktree: $WORKTREE_DIR"
if git worktree remove "$WORKTREE_DIR" --force; then
    success "Worktree removed"
else
    error "Failed to remove worktree"
fi

# Clean up empty worktrees directory if it exists
if [ -d "$WORKTREE_BASE" ] && [ -z "$(ls -A "$WORKTREE_BASE")" ]; then
    rmdir "$WORKTREE_BASE"
    info "Removed empty worktrees directory"
fi

success "Branch '$BRANCH_NAME' and its worktree have been removed"
